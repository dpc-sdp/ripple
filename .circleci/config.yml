version: 2.1

parameters:
  e2e:
    type: boolean
    default: false
  e2e_be_url:
    type: string
    default: ''
  e2e_fe_url:
    type: string
    default: ''
  e2e_project:
    type: string
    default: ''

defaults: &defaults
  docker:
    - image: cypress/browsers:node14.7.0-chrome84
      environment:
        CIRCLE_TEST_REPORTS: test-results
        TZ: "Australia/Melbourne"
      auth:
        username: $DOCKERHUB_USERNAME
        password: $DOCKERHUB_PASSWORD
  working_directory: ~/app

orbs:
  sdp-test: dpc-sdp/sdp-test@1

jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - v9-deps-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile --cache-folder ~/.cache/yarn
      - save_cache:
          key: v9-deps-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache
      - run:
          name: build vic-gov-au nuxt app
          command: cd examples/vic-gov-au && yarn build:default
      - persist_to_workspace:
          root: ~/app
          paths: .

  test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - restore_cache:
          keys:
            - v9-deps-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Lint code.
          command: yarn lint --format ./node_modules/eslint-junit/index.js
          environment:
             ESLINT_JUNIT_OUTPUT: ./test-results/lint/eslint.xml
      - run:
          name: Unit tests
          command: yarn test:unit --ci --runInBand --reporters=default --reporters=jest-junit
          environment:
            JEST_JUNIT_OUTPUT_DIR: test-results/unit/
      - persist_to_workspace:
          root: ~/app
          paths: .
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
      - store_artifacts:
          path: examples/vic-gov-au/test/integration/videos
      - store_artifacts:
          path: examples/vic-gov-au/test/integration/screenshots



  integration-vic-gov:
    # Integration tests confirm FE components are working correctly without testing BE
    <<: *defaults
    parallelism: 2
    steps:
      - attach_workspace:
          at: ~/app
      - restore_cache:
          keys:
            - v9-deps-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: run full integration test
          command: yarn test:integration-vic
      - store_artifacts:
          path: test-results
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: examples/vic-gov-au/test/integration/videos
      - store_artifacts:
          path: examples/vic-gov-au/test/integration/screenshots


  integration-example:
    # This runs the full suite of integration tests on example nuxt tide app
    docker:
      - image: cypress/browsers:node14.16.0-chrome89-ff86
        environment:
          TERM: xterm
    working_directory: ~/app
    steps:
      - attach_workspace:
          at: ~/app
      - restore_cache:
          keys:
            - v9-deps-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: build example nuxt app
          command: cd examples/basic-examples && yarn build:default
      - run:
          name: run full integration test
          command: yarn test:integration-example
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
      - store_artifacts:
          path: examples/vic-gov-au/test/integration/videos
      - store_artifacts:
          path: examples/vic-gov-au/test/integration/screenshots

  integration-vue-example-app:
  # This runs the full suite of integration tests on example vue example app
    docker:
      - image: cypress/browsers:node14.16.0-chrome89-ff86
        environment:
          TERM: xterm
    working_directory: ~/app
    steps:
      - attach_workspace:
          at: ~/app      
      - restore_cache:
          keys:
            - v9-deps-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: build example nuxt app
          command: cd examples/vue-example-app && yarn build      
      - run:
          name: run smoke test
          command: cd examples/vue-example-app && yarn test:smoke
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
      - store_artifacts:
          path: examples/vue-example-app/test/integration/videos
      - store_artifacts:
          path: examples/vue-example-app/test/integration/screenshots

  storybook:
    docker:
      - image: cypress/base:14.16.0
        environment:
          TERM: xterm
    working_directory: ~/app
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: run UI test
          command: cd src && yarn chromatic --project-token $CHROMATIC_APP_CODE --exit-zero-on-changes

workflows:
  version: 2
  commit:
    when:
      not: << pipeline.parameters.e2e >>  
    jobs:
      - build:
          context: Ripple
      - storybook:
          context: Ripple
          requires:
            - build
      - test:
          context: Ripple
          requires:
            - build
      # Run regression tests on release branches
      - integration-example:
          requires:
            - build
          filters:
            branches:
              only:
                - /^release\/.*/
      - integration-vue-example-app:
          requires:
            - build
          filters:
            branches:
              only:
                - /^release\/.*/
